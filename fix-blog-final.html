<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Limpiar Datos Blog - Espacio Shanti</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .button {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      .button:hover {
        background: #0056b3;
      }
      .button.danger {
        background: #dc3545;
      }
      .button.danger:hover {
        background: #c82333;
      }
      .button.success {
        background: #28a745;
      }
      .button.success:hover {
        background: #218838;
      }
      .output {
        background: #f8f9fa;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
        min-height: 100px;
      }
      .error {
        color: red;
      }
      .success {
        color: green;
      }
      .warning {
        color: orange;
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ§¹ Limpiar Datos del Blog</h1>

      <div class="output">
        <h3>âš ï¸ Advertencia</h3>
        <p>
          Esta herramienta corregirÃ¡ los datos corruptos del blog que tienen:
        </p>
        <ul>
          <li>âŒ Emoji "undefined"</li>
          <li>âŒ Fechas en formato incorrecto</li>
          <li>âŒ Campos faltantes</li>
        </ul>
      </div>

      <div>
        <button class="button" onclick="analyzeData()">
          ğŸ” Analizar Datos
        </button>
        <button class="button success" onclick="fixData()">
          ğŸ”§ Reparar Datos
        </button>
        <button class="button danger" onclick="clearAll()">
          ğŸ—‘ï¸ Eliminar Todo
        </button>
      </div>

      <div id="output" class="output">
        Haz clic en "Analizar Datos" para comenzar...
      </div>
    </div>

    <script>
      function log(message, type = "info") {
        const output = document.getElementById("output");
        const timestamp = new Date().toLocaleTimeString();
        const colorClass =
          type === "error"
            ? "error"
            : type === "success"
            ? "success"
            : type === "warning"
            ? "warning"
            : "";
        output.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
      }

      function clearOutput() {
        document.getElementById("output").innerHTML = "";
      }

      function analyzeData() {
        clearOutput();
        log("ğŸ” Analizando datos del blog...", "info");

        try {
          const entries = JSON.parse(
            localStorage.getItem("blogEntries") || "[]"
          );

          if (entries.length === 0) {
            log("âŒ No hay entradas para analizar", "error");
            return;
          }

          log(`ğŸ“Š Encontradas ${entries.length} entradas`, "info");

          let issuesFound = 0;

          entries.forEach((entry, index) => {
            log(
              `\nğŸ“‹ Analizando entrada ${index + 1}: "${
                entry.title || "Sin tÃ­tulo"
              }"`,
              "info"
            );

            // Check emoji
            if (
              !entry.emoji ||
              entry.emoji === "undefined" ||
              entry.emoji.toLowerCase() === "undefined"
            ) {
              log(`  âŒ Emoji corrupto: "${entry.emoji}"`, "error");
              issuesFound++;
            } else {
              log(`  âœ… Emoji OK: ${entry.emoji}`, "success");
            }

            // Check date
            const hasCreatedAt =
              entry.createdAt && typeof entry.createdAt === "string";
            const hasDate = entry.date && typeof entry.date === "string";

            if (!hasCreatedAt && !hasDate) {
              log(`  âŒ Sin fecha vÃ¡lida`, "error");
              issuesFound++;
            } else if (hasDate && !hasCreatedAt) {
              log(`  âš ï¸ Solo tiene "date", falta "createdAt"`, "warning");
              issuesFound++;
            } else {
              log(`  âœ… Fecha OK`, "success");
            }

            // Check author
            if (!entry.author || entry.author === "undefined") {
              log(`  âŒ Autor corrupto: "${entry.author}"`, "error");
              issuesFound++;
            } else {
              log(`  âœ… Autor OK: ${entry.author}`, "success");
            }

            // Check category
            if (!entry.category || entry.category === "undefined") {
              log(`  âŒ CategorÃ­a corrupta: "${entry.category}"`, "error");
              issuesFound++;
            } else {
              log(`  âœ… CategorÃ­a OK: ${entry.category}`, "success");
            }
          });

          if (issuesFound > 0) {
            log(
              `\nâš ï¸ Se encontraron ${issuesFound} problemas. Usa "Reparar Datos" para corregirlos.`,
              "warning"
            );
          } else {
            log(`\nâœ… No se encontraron problemas en los datos`, "success");
          }
        } catch (error) {
          log(`âŒ Error al analizar datos: ${error.message}`, "error");
        }
      }

      function fixData() {
        clearOutput();
        log("ğŸ”§ Reparando datos del blog...", "info");

        try {
          const entries = JSON.parse(
            localStorage.getItem("blogEntries") || "[]"
          );

          if (entries.length === 0) {
            log("âŒ No hay entradas para reparar", "error");
            return;
          }

          let fixedCount = 0;
          const fixedEntries = entries.map((entry, index) => {
            log(
              `\nğŸ”§ Reparando entrada ${index + 1}: "${
                entry.title || "Sin tÃ­tulo"
              }"`,
              "info"
            );

            const fixed = { ...entry };
            let entryFixed = false;

            // Fix emoji
            if (
              !fixed.emoji ||
              fixed.emoji === "undefined" ||
              fixed.emoji.toLowerCase() === "undefined"
            ) {
              // Set emoji based on category
              const categoryEmojis = {
                terapias: "ğŸ’†â€â™€ï¸",
                meditacion: "ğŸ§˜â€â™€ï¸",
                yoga: "ğŸ§˜â€â™‚ï¸",
                reiki: "âœ¨",
                bienestar: "ğŸŒ¸",
                consejos: "ğŸ’¡",
                general: "ğŸ“",
                debug: "ğŸ”§",
                prueba: "ğŸ§ª",
              };
              fixed.emoji = categoryEmojis[fixed.category] || "ğŸ“";
              log(`  âœ… Emoji reparado: ${fixed.emoji}`, "success");
              entryFixed = true;
            }

            // Fix date - ensure both createdAt and date exist
            if (!fixed.createdAt) {
              if (fixed.date && typeof fixed.date === "string") {
                // If date is in Spanish format, convert to ISO
                if (fixed.date.includes("de")) {
                  // Keep the date field as is, but create a proper createdAt
                  // For now, use current date as we can't perfectly parse Spanish dates
                  fixed.createdAt = new Date().toISOString();
                  log(
                    `  âœ… createdAt aÃ±adido basado en fecha actual`,
                    "success"
                  );
                } else {
                  // Try to parse the date
                  const parsedDate = new Date(fixed.date);
                  if (!isNaN(parsedDate.getTime())) {
                    fixed.createdAt = parsedDate.toISOString();
                    log(
                      `  âœ… createdAt aÃ±adido: ${fixed.createdAt}`,
                      "success"
                    );
                  } else {
                    fixed.createdAt = new Date().toISOString();
                    log(
                      `  âš ï¸ createdAt aÃ±adido con fecha actual (no se pudo parsear)`,
                      "warning"
                    );
                  }
                }
                entryFixed = true;
              } else {
                // No date at all, add current date
                const now = new Date();
                fixed.createdAt = now.toISOString();
                fixed.date = now.toLocaleDateString("es-ES", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                });
                log(`  âœ… Fecha completa aÃ±adida (actual)`, "success");
                entryFixed = true;
              }
            }

            // Fix author
            if (!fixed.author || fixed.author === "undefined") {
              fixed.author = "equipo@espacioshanti.com";
              log(`  âœ… Autor reparado: ${fixed.author}`, "success");
              entryFixed = true;
            }

            // Fix category
            if (!fixed.category || fixed.category === "undefined") {
              fixed.category = "general";
              log(`  âœ… CategorÃ­a reparada: ${fixed.category}`, "success");
              entryFixed = true;
            }

            // Ensure summary and content exist
            if (!fixed.summary) {
              fixed.summary = fixed.content
                ? fixed.content.substring(0, 100) + "..."
                : "Sin resumen";
              entryFixed = true;
            }

            if (!fixed.content) {
              fixed.content = "Contenido no disponible";
              entryFixed = true;
            }

            if (entryFixed) {
              fixedCount++;
              log(`  âœ… Entrada ${index + 1} reparada`, "success");
            } else {
              log(`  âœ… Entrada ${index + 1} ya estaba OK`, "success");
            }

            return fixed;
          });

          // Save fixed data
          localStorage.setItem("blogEntries", JSON.stringify(fixedEntries));

          log(`\nğŸ‰ ReparaciÃ³n completada!`, "success");
          log(`ğŸ“Š ${fixedCount} entradas fueron reparadas`, "info");
          log(`ğŸ’¾ Datos guardados en localStorage`, "success");
          log(`\nğŸ”„ Ahora puedes ir a index.html para ver los cambios`, "info");
        } catch (error) {
          log(`âŒ Error al reparar datos: ${error.message}`, "error");
        }
      }

      function clearAll() {
        if (
          confirm(
            "Â¿EstÃ¡s seguro de que quieres eliminar TODAS las entradas del blog?"
          )
        ) {
          localStorage.removeItem("blogEntries");
          clearOutput();
          log("ğŸ—‘ï¸ Todas las entradas han sido eliminadas", "warning");
          log("ğŸ“Š localStorage limpio", "info");
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        log("ğŸš€ Herramienta de reparaciÃ³n cargada", "success");
      });
    </script>
  </body>
</html>
